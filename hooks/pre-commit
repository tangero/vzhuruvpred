#!/bin/bash
# Pre-commit hook pro kontrolu CHANGELOG.md
# UmÃ­stit do: .git/hooks/pre-commit a uÄinit spustitelnÃ½m: chmod +x .git/hooks/pre-commit

echo "ğŸ” Kontrolujem zmÄ›ny pÅ™ed commitem..."

# ZÃ­skat seznam zmÄ›nÄ›nÃ½ch souborÅ¯
CHANGED_FILES=$(git diff --cached --name-only)

# Kontrola, zda byly zmÄ›nÄ›ny zdrojovÃ© soubory
if echo "$CHANGED_FILES" | grep -E "\.(js|html|md|yml|yaml|css|scss|liquid)$" > /dev/null; then
    echo "ğŸ“ DetekovanÃ© zmÄ›ny ve zdrojovÃ½ch souborech:"
    echo "$CHANGED_FILES" | grep -E "\.(js|html|md|yml|yaml|css|scss|liquid)$" | sed 's/^/   - /'
    
    # Kontrola, zda byl aktualizovÃ¡n CHANGELOG.md
    if ! echo "$CHANGED_FILES" | grep "CHANGELOG.md" > /dev/null; then
        echo ""
        echo "âš ï¸  UPOZORNÄšNÃ: CHANGELOG.md nebyl aktualizovÃ¡n!"
        echo ""
        echo "   ZvaÅ¾te pÅ™idÃ¡nÃ­ tÃ©to zmÄ›ny do CHANGELOG.md:"
        echo "   1. OtevÅ™ete CHANGELOG.md"
        echo "   2. PÅ™idejte poloÅ¾ku do sekce [Unreleased]"  
        echo "   3. PouÅ¾ijte formÃ¡t: - **NÃ¡zev zmÄ›ny** - popis"
        echo ""
        echo "   Typy zmÄ›n: PÅ™idÃ¡no, ZmÄ›nÄ›no, Opraveno, OdstranÄ›no, BezpeÄnost"
        echo ""
        
        # Pokus o automatickÃ© rozpoznÃ¡nÃ­ typu zmÄ›ny
        COMMIT_MSG=$(git log --format=%B -n 1 2>/dev/null || echo "")
        if echo "$COMMIT_MSG" | grep -iE "^(feat|feature|add)" > /dev/null; then
            echo "   ğŸ’¡ Tip: VypadÃ¡ to jako novÃ¡ funkcionalita â†’ pouÅ¾ijte 'PÅ™idÃ¡no'"
        elif echo "$COMMIT_MSG" | grep -iE "^(fix|bug)" > /dev/null; then
            echo "   ğŸ’¡ Tip: VypadÃ¡ to jako oprava chyby â†’ pouÅ¾ijte 'Opraveno'" 
        elif echo "$COMMIT_MSG" | grep -iE "^(update|change|modify)" > /dev/null; then
            echo "   ğŸ’¡ Tip: VypadÃ¡ to jako Ãºprava â†’ pouÅ¾ijte 'ZmÄ›nÄ›no'"
        fi
        
        echo ""
        echo "   Pro pokraÄovÃ¡nÃ­ bez aktualizace pouÅ¾ijte: git commit --no-verify"
        echo ""
        
        read -p "   Chcete pokraÄovat v commitu? (y/N): " -n 1 -r
        echo ""
        
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo ""
            echo "âŒ Commit zruÅ¡en. Aktualizujte CHANGELOG.md a zkuste znovu."
            echo ""
            echo "   PÅ™Ã­klad entry pro CHANGELOG.md:"
            echo "   ### PÅ™idÃ¡no/ZmÄ›nÄ›no/Opraveno"
            echo "   - **$(echo "$CHANGED_FILES" | head -1 | sed 's/.*\///' | sed 's/\.[^.]*$//')** - popis zmÄ›ny"
            echo ""
            exit 1
        fi
        
        echo ""
        echo "âš ï¸  PokraÄuji bez aktualizace changelogu..."
    else
        echo ""
        echo "âœ… CHANGELOG.md byl aktualizovÃ¡n - skvÄ›lÃ©!"
    fi
fi

# Kontrola, zda changelog entry mÃ¡ sprÃ¡vnÃ½ formÃ¡t
if echo "$CHANGED_FILES" | grep "CHANGELOG.md" > /dev/null; then
    if git diff --cached CHANGELOG.md | grep -E "^\+.*\[Unreleased\]" -A 20 | grep -E "^\+\s*-\s*\*\*.*\*\*" > /dev/null; then
        echo "âœ… Changelog entry mÃ¡ sprÃ¡vnÃ½ formÃ¡t"
    else
        echo ""
        echo "âš ï¸  UpozornÄ›nÃ­: Changelog entry moÅ¾nÃ¡ nemÃ¡ sprÃ¡vnÃ½ formÃ¡t"
        echo "   OÄekÃ¡vanÃ½ formÃ¡t: - **NÃ¡zev** - popis"
        echo ""
    fi
fi

echo ""
echo "ğŸš€ Pre-commit kontroly dokonÄeny!"
echo ""

exit 0