{% comment %}
Weather Widget Component
Uses Open-Meteo API for free weather data without API key
{% endcomment %}

{% if site.weather.enabled %}
<div class="weather-widget" id="weather-widget">
    <div class="weather-header">
        <h3 class="weather-title">
            <span class="weather-icon">ğŸŒ¤ï¸</span>
            PoÄasÃ­
        </h3>
        <select class="weather-city-select" id="weather-city-select">
            {% for city in site.weather.cities %}
            <option value="{{ city.latitude }},{{ city.longitude }}" {% if city.name == site.weather.default_location.name %}selected{% endif %}>
                {{ city.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="weather-content" id="weather-content">
        <div class="weather-loading">
            <div class="weather-spinner"></div>
            <span>NaÄÃ­tÃ¡nÃ­...</span>
        </div>
    </div>
    
    <div class="weather-error" id="weather-error" style="display: none;">
        <span class="weather-error-icon">âš ï¸</span>
        <span class="weather-error-text">NepodaÅ™ilo se naÄÃ­st poÄasÃ­</span>
        <button class="weather-retry-btn" onclick="loadWeatherData()">Zkusit znovu</button>
    </div>
    
    <div class="weather-updated" id="weather-updated" style="display: none;">
        <small>AktualizovÃ¡no: <span id="weather-last-update"></span></small>
    </div>
</div>

<script>
// Weather Widget Configuration
const WEATHER_CONFIG = {
    apiUrl: "{{ site.weather.api_url }}",
    defaultLocation: {
        name: "{{ site.weather.default_location.name }}",
        latitude: {{ site.weather.default_location.latitude }},
        longitude: {{ site.weather.default_location.longitude }}
    },
    updateInterval: {{ site.weather.update_interval }},
    cacheDuration: {{ site.weather.cache_duration }}
};

// Weather icons mapping
const WEATHER_ICONS = {
    0: 'â˜€ï¸',   // Clear sky
    1: 'ğŸŒ¤ï¸',   // Mainly clear
    2: 'â›…',   // Partly cloudy
    3: 'â˜ï¸',   // Overcast
    45: 'ğŸŒ«ï¸',  // Fog
    48: 'ğŸŒ«ï¸',  // Depositing rime fog
    51: 'ğŸŒ¦ï¸',  // Light drizzle
    53: 'ğŸŒ¦ï¸',  // Moderate drizzle
    55: 'ğŸŒ§ï¸',  // Dense drizzle
    56: 'ğŸŒ§ï¸',  // Light freezing drizzle
    57: 'ğŸŒ§ï¸',  // Dense freezing drizzle
    61: 'ğŸŒ§ï¸',  // Slight rain
    63: 'ğŸŒ§ï¸',  // Moderate rain
    65: 'ğŸŒ§ï¸',  // Heavy rain
    66: 'ğŸŒ§ï¸',  // Light freezing rain
    67: 'ğŸŒ§ï¸',  // Heavy freezing rain
    71: 'ğŸŒ¨ï¸',  // Slight snow fall
    73: 'ğŸŒ¨ï¸',  // Moderate snow fall
    75: 'â„ï¸',   // Heavy snow fall
    77: 'â„ï¸',   // Snow grains
    80: 'ğŸŒ¦ï¸',  // Slight rain showers
    81: 'ğŸŒ§ï¸',  // Moderate rain showers
    82: 'ğŸŒ§ï¸',  // Violent rain showers
    85: 'ğŸŒ¨ï¸',  // Slight snow showers
    86: 'â„ï¸',   // Heavy snow showers
    95: 'â›ˆï¸',   // Thunderstorm
    96: 'â›ˆï¸',   // Thunderstorm with slight hail
    99: 'â›ˆï¸'    // Thunderstorm with heavy hail
};

// Weather descriptions in Czech
const WEATHER_DESCRIPTIONS = {
    0: 'Jasno',
    1: 'PÅ™evÃ¡Å¾nÄ› jasno',
    2: 'ÄŒÃ¡steÄnÄ› oblaÄno',
    3: 'ZataÅ¾eno',
    45: 'Mlha',
    48: 'NÃ¡mraza',
    51: 'SlabÃ© mrholenÃ­',
    53: 'MÃ­rnÃ© mrholenÃ­',
    55: 'HustÃ© mrholenÃ­',
    56: 'SlabÃ© mrznoucÃ­ mrholenÃ­',
    57: 'HustÃ© mrznoucÃ­ mrholenÃ­',
    61: 'SlabÃ½ dÃ©Å¡Å¥',
    63: 'MÃ­rnÃ½ dÃ©Å¡Å¥',
    65: 'SilnÃ½ dÃ©Å¡Å¥',
    66: 'SlabÃ½ mrznoucÃ­ dÃ©Å¡Å¥',
    67: 'SilnÃ½ mrznoucÃ­ dÃ©Å¡Å¥',
    71: 'SlabÃ© snÄ›Å¾enÃ­',
    73: 'MÃ­rnÃ© snÄ›Å¾enÃ­',
    75: 'SilnÃ© snÄ›Å¾enÃ­',
    77: 'SnÄ›hovÃ© zrno',
    80: 'SlabÃ© pÅ™ehÃ¡Åˆky',
    81: 'MÃ­rnÃ© pÅ™ehÃ¡Åˆky',
    82: 'SilnÃ© pÅ™ehÃ¡Åˆky',
    85: 'SlabÃ© snÄ›hovÃ© pÅ™ehÃ¡Åˆky',
    86: 'SilnÃ© snÄ›hovÃ© pÅ™ehÃ¡Åˆky',
    95: 'BouÅ™ka',
    96: 'BouÅ™ka s krupobitÃ­m',
    99: 'BouÅ™ka se silnÃ½m krupobitÃ­m'
};

// Initialize weather widget on page load
document.addEventListener('DOMContentLoaded', function() {
    initWeatherWidget();
});

function initWeatherWidget() {
    // Set up city selector change event
    const citySelect = document.getElementById('weather-city-select');
    if (citySelect) {
        citySelect.addEventListener('change', function() {
            const [lat, lon] = this.value.split(',');
            const cityName = this.options[this.selectedIndex].text;
            loadWeatherData(parseFloat(lat), parseFloat(lon), cityName);
        });
    }
    
    // Load initial weather data
    loadWeatherData();
    
    // Set up automatic updates
    setInterval(loadWeatherData, WEATHER_CONFIG.updateInterval);
}

async function loadWeatherData(lat, lon, cityName) {
    const latitude = lat || WEATHER_CONFIG.defaultLocation.latitude;
    const longitude = lon || WEATHER_CONFIG.defaultLocation.longitude;
    const city = cityName || WEATHER_CONFIG.defaultLocation.name;
    
    const cacheKey = `weather_${latitude}_${longitude}`;
    const cachedData = getCachedWeatherData(cacheKey);
    
    if (cachedData) {
        displayWeatherData(cachedData, city);
        return;
    }
    
    showWeatherLoading();
    
    try {
        const url = `${WEATHER_CONFIG.apiUrl}/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe/Prague`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // Cache the data
        cacheWeatherData(cacheKey, data);
        
        displayWeatherData(data, city);
        hideWeatherError();
        
    } catch (error) {
        console.error('Weather API error:', error);
        showWeatherError();
    }
}

function getCachedWeatherData(cacheKey) {
    try {
        const cached = localStorage.getItem(cacheKey);
        if (!cached) return null;
        
        const { data, timestamp } = JSON.parse(cached);
        const now = new Date().getTime();
        
        // Check if cache is still valid
        if (now - timestamp < WEATHER_CONFIG.cacheDuration) {
            return data;
        } else {
            localStorage.removeItem(cacheKey);
            return null;
        }
    } catch (error) {
        console.error('Cache error:', error);
        return null;
    }
}

function cacheWeatherData(cacheKey, data) {
    try {
        const cacheData = {
            data: data,
            timestamp: new Date().getTime()
        };
        localStorage.setItem(cacheKey, JSON.stringify(cacheData));
    } catch (error) {
        console.error('Cache save error:', error);
    }
}

function displayWeatherData(data, cityName) {
    const contentDiv = document.getElementById('weather-content');
    const current = data.current;
    const daily = data.daily;
    
    const currentIcon = WEATHER_ICONS[current.weather_code] || 'ğŸŒ¤ï¸';
    const currentDescription = WEATHER_DESCRIPTIONS[current.weather_code] || 'NeznÃ¡mÃ© poÄasÃ­';
    
    const html = `
        <div class="weather-current">
            <div class="weather-main">
                <span class="weather-current-icon">${currentIcon}</span>
                <div class="weather-temp-info">
                    <span class="weather-temperature">${Math.round(current.temperature_2m)}Â°C</span>
                    <span class="weather-description">${currentDescription}</span>
                </div>
            </div>
            <div class="weather-details">
                <div class="weather-detail">
                    <span class="weather-detail-label">Vlhkost:</span>
                    <span class="weather-detail-value">${current.relative_humidity_2m}%</span>
                </div>
                <div class="weather-detail">
                    <span class="weather-detail-label">VÃ­tr:</span>
                    <span class="weather-detail-value">${Math.round(current.wind_speed_10m)} km/h</span>
                </div>
            </div>
        </div>
        
        <div class="weather-forecast">
            <h4 class="weather-forecast-title">PÅ™edpovÄ›Ä na 3 dny</h4>
            <div class="weather-forecast-days">
                ${daily.time.slice(1, 4).map((date, index) => {
                    const dayIndex = index + 1;
                    const dayName = getDayName(new Date(date));
                    const icon = WEATHER_ICONS[daily.weather_code[dayIndex]] || 'ğŸŒ¤ï¸';
                    const maxTemp = Math.round(daily.temperature_2m_max[dayIndex]);
                    const minTemp = Math.round(daily.temperature_2m_min[dayIndex]);
                    
                    return `
                        <div class="weather-forecast-day">
                            <span class="weather-forecast-day-name">${dayName}</span>
                            <span class="weather-forecast-icon">${icon}</span>
                            <div class="weather-forecast-temps">
                                <span class="weather-forecast-max">${maxTemp}Â°</span>
                                <span class="weather-forecast-min">${minTemp}Â°</span>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
    
    contentDiv.innerHTML = html;
    
    // Update last updated time
    updateLastUpdateTime();
    
    hideWeatherLoading();
}

function getDayName(date) {
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    if (date.toDateString() === tomorrow.toDateString()) {
        return 'ZÃ­tra';
    }
    
    const dayNames = ['Ne', 'Po', 'Ãšt', 'St', 'ÄŒt', 'PÃ¡', 'So'];
    return dayNames[date.getDay()];
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('cs-CZ', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    const updateElement = document.getElementById('weather-last-update');
    const updatedElement = document.getElementById('weather-updated');
    
    if (updateElement && updatedElement) {
        updateElement.textContent = timeString;
        updatedElement.style.display = 'block';
    }
}

function showWeatherLoading() {
    const contentDiv = document.getElementById('weather-content');
    const errorDiv = document.getElementById('weather-error');
    const updatedDiv = document.getElementById('weather-updated');
    
    if (contentDiv) {
        contentDiv.innerHTML = `
            <div class="weather-loading">
                <div class="weather-spinner"></div>
                <span>NaÄÃ­tÃ¡nÃ­...</span>
            </div>
        `;
    }
    if (errorDiv) errorDiv.style.display = 'none';
    if (updatedDiv) updatedDiv.style.display = 'none';
}

function hideWeatherLoading() {
    // Loading is hidden when content is displayed
}

function showWeatherError() {
    const errorDiv = document.getElementById('weather-error');
    const contentDiv = document.getElementById('weather-content');
    const updatedDiv = document.getElementById('weather-updated');
    
    if (errorDiv) errorDiv.style.display = 'block';
    if (contentDiv) contentDiv.style.display = 'none';
    if (updatedDiv) updatedDiv.style.display = 'none';
}

function hideWeatherError() {
    const errorDiv = document.getElementById('weather-error');
    const contentDiv = document.getElementById('weather-content');
    
    if (errorDiv) errorDiv.style.display = 'none';
    if (contentDiv) contentDiv.style.display = 'block';
}
</script>
{% endif %}